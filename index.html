<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TK A330 EFB (Perf)</title>
    
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAAbFBMVEUAAADjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgAAAADc0A/lAAAAI3RSTlMAGfCc7vO/gH+wPzC/r39gcGBfX14/MC8vL29vX19fX19fX19J15N5AAAEZUlEQVR42u3c6XbiOhSA4QyBQBodmjaF0vZ+3/+VFs4wQ7FkK7YkK3V9/5WzkCw/WfaSjXF9fX19fX19fX19fX19fX19fX19fX19fX19fX39/9T159v7+8fH+/v72/P19fXydv94//h4f76/f37V9X/W9e324/3j9e3t9fX5/Pj4eP/2/vz4fH97fX1/v/34Vdf/T9f3t/e3t+fH+/vH6+v7x8fb8/vbe13/T93e357fP5/v7+/P7+/Pj4/3t+f6/f/r29v7x/Pj4/3t+fH+/vH89l6v/5e6vb09Pz/eP96fnx/vH2/P9fr/Vbe3t/f3t/fn+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/v7/6/r/wO4gJ5C1X7n2AAAAABJRU5ErkJggg==">

    <style>
        /* ÂÖ®Â±ÄË®≠ÂÆö */
        body { background-color: #0d0d0d; color: #ccc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; margin: 0; padding: 0; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); display: flex; flex-direction: column; height: 100vh; overflow: hidden; -webkit-user-select: none; }
        
        /* È†ÇÈÉ®Â∞éËà™Âàó */
        .nav-header { background-color: #1e1e1e; border-bottom: 2px solid #e30a17; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; color: #fff; z-index: 10; display: flex; justify-content: space-between; align-items: center; padding-top: max(15px, env(safe-area-inset-top)); margin-top: -env(safe-area-inset-top); }
        .reset-btn { background: #333; color: #888; border: 1px solid #555; font-size: 10px; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        
        /* ÂÖßÂÆπÂÆπÂô® */
        .content-container { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 15px; padding-bottom: 100px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Â∫ïÈÉ®Â∞éËà™Âàó */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background-color: #1e1e1e; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(20px, env(safe-area-inset-bottom)); z-index: 20; }
        .nav-btn { background: none; border: none; color: #666; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .nav-btn.active { color: #e30a17; }
        .nav-icon { font-size: 20px; }
        
        /* Áè≠Ë°®Âç°ÁâáÊ®£Âºè */
        .flight-card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 8px; margin-bottom: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; transition: 0.2s; }
        .flight-card:active { background-color: #2a2a2a; }
        .flight-info { flex: 1; margin-right: 10px; }
        .flight-day { font-size: 12px; color: #e30a17; font-weight: bold; margin-bottom: 4px; }
        .flight-route { font-size: 15px; color: #fff; font-weight: bold; margin-bottom: 6px; }
        .flight-desc { font-size: 13px; color: #bbb; line-height: 1.5; white-space: normal; word-break: break-word; }
        .flight-card.completed { opacity: 0.5; border-color: #2ecc71; }
        .flight-card.completed .flight-day { color: #2ecc71; }
        .check-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #555; background: none; display: flex; justify-content: center; align-items: center; color: transparent; flex-shrink: 0; margin-top: 5px; }
        .flight-card.completed .check-btn { background-color: #2ecc71; border-color: #2ecc71; color: #000; }

        /* Ë®àÁÆóÊ©üÊ®£Âºè */
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        label { font-size: 12px; color: #eee; width: 40%; }
        input, select { width: 55%; background-color: #000; border: 1px solid #444; color: #00ff00; font-family: monospace; font-size: 16px; text-align: right; padding: 8px; border-radius: 4px; -webkit-appearance: none; }
        select { text-align: center; color: #00bfff; }
        .section-header { font-size: 12px; color: #e30a17; font-weight: bold; margin-top: 20px; margin-bottom: 8px; border-bottom: 1px dashed #444; padding-bottom: 2px; }
        .btn-calc { width: 100%; padding: 15px; background-color: #e30a17; color: #fff; border: none; font-size: 16px; font-weight: bold; margin-top: 20px; border-radius: 6px; }
        .result-box { background-color: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .divider { border-bottom: 1px solid #222; margin: 8px 0; }
        
        /* ÊÄßËÉΩË≥áÊñôÈ°ØÁ§∫Ê†º */
        .perf-section { background: #1a1a1a; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #333; }
        .perf-title { font-size: 11px; color: #aaa; margin-bottom: 5px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center; }
        .data-item div:first-child { font-size: 10px; color: #666; }
        .data-item div:last-child { font-size: 14px; color: #fff; font-weight: bold; }
        
        .current-flight-banner { background: #2a2a2a; padding: 10px; border-left: 4px solid #00bfff; margin-bottom: 15px; border-radius: 4px; }
        .banner-desc { font-size: 12px; color: #ddd; margin-top: 4px; line-height: 1.4; }
    </style>
</head>
<body>

    <script src="roster.js"></script>
    <script src="perf_db.js"></script>

    <div class="nav-header">
        TK A330 EFB
        <button class="reset-btn" onclick="clearAllData()">RESET ALL</button>
    </div>

    <div class="content-container">
        
        <div id="tab-roster" class="tab-content active">
            <div id="roster-list"></div>
            <div style="text-align:center; color:#555; font-size:12px; margin-top:20px;">
                ‚Äî END OF ROSTER ‚Äî
            </div>
        </div>

        <div id="tab-calc" class="tab-content">
            
            <div class="current-flight-banner">
                <div style="font-size:12px; color:#aaa;">CURRENT FLIGHT</div>
                <div id="calc-flight-title" style="color:#fff; font-weight:bold; font-size:16px;">NO FLIGHT SELECTED</div>
                <div id="calc-flight-desc" class="banner-desc">Select from Roster</div>
            </div>

            <div class="section-header">RUNWAY & WEATHER</div>
            <div class="input-row">
                <label>RWY LEN (M)</label>
                <input type="number" id="rwy-len" placeholder="e.g. 3000" oninput="saveInputs()">
            </div>
            <div class="input-row">
                <label>RWY COND</label>
                <select id="rwy-cond" onchange="saveInputs()">
                    <option value="DRY">DRY (‰πæÂú∞)</option>
                    <option value="WET">WET (ÊøïÂú∞)</option>
                </select>
            </div>
            <div class="input-row">
                <label>WIND (DIR/SPD)</label>
                <div style="display:flex; gap:5px; width:55%;">
                    <input type="number" id="wind-dir" placeholder="DIR" oninput="saveInputs()">
                    <input type="number" id="wind-spd" placeholder="SPD" oninput="saveInputs()">
                </div>
            </div>
            <div class="input-row">
                <label>RWY HDG</label>
                <input type="number" id="rwy-hdg" placeholder="e.g. 360" oninput="saveInputs()">
            </div>

            <div class="section-header">LOAD & FUEL</div>
            <div class="input-row">
                <label>PAX (Total)</label>
                <input type="number" id="pax-count" oninput="updatePaxWeight(); saveInputs();">
            </div>
            <div class="input-row">
                <label>CARGO FWD</label>
                <input type="number" id="cargo-fwd" oninput="updateTotalCargo(); saveInputs();">
            </div>
            <div class="input-row">
                <label>CARGO AFT</label>
                <input type="number" id="cargo-aft" oninput="updateTotalCargo(); saveInputs();">
            </div>
            <div class="input-row">
                <label>FUEL TOTAL</label>
                <input type="number" id="fuel-total" oninput="saveInputs()">
            </div>
            <div class="input-row">
                <label style="color:#ff9900;">TRIP FUEL</label>
                <input type="number" id="trip-fuel" style="border-color:#ff9900;" oninput="saveInputs()">
            </div>

            <input type="hidden" id="pax-weight">
            <input type="hidden" id="cargo-total">

            <button class="btn-calc" onclick="calculate()">CALCULATE PERFORMANCE</button>

            <div class="result-box">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="color:#888; font-size:12px;">TAKEOFF WEIGHT</span>
                    <span id="res-tow" style="font-size:14px; font-weight:bold; color:#fff;">--- T</span>
                </div>

                <div class="perf-section">
                    <div class="perf-title" style="color:#00ff00;">TAKEOFF DATA</div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div>CONFIG</div>
                            <div id="res-conf">1+F</div>
                        </div>
                        <div class="data-item">
                            <div>FLEX</div>
                            <div id="res-flex" style="color:#00bfff;">--</div>
                        </div>
                        <div class="data-item">
                            <div>TRIM</div>
                            <div id="res-trim">--</div>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div>V1</div>
                            <div id="res-v1" style="color:#e30a17;">--</div>
                        </div>
                        <div class="data-item">
                            <div>VR</div>
                            <div id="res-vr" style="color:#e30a17;">--</div>
                        </div>
                        <div class="data-item">
                            <div>V2</div>
                            <div id="res-v2" style="color:#e30a17;">--</div>
                        </div>
                    </div>
                </div>

                <div class="perf-section">
                    <div class="perf-title" style="color:#ffcc00;">LANDING DATA</div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; padding:0 5px;">
                        <span style="font-size:10px; color:#888;">EST LDW</span>
                        <span id="res-ldw" style="font-size:12px; color:#fff;">--- T</span>
                    </div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div>VAPP</div>
                            <div id="res-vapp" style="color:#ffcc00;">--</div>
                        </div>
                        <div class="data-item">
                            <div>CONF</div>
                            <div>FULL</div>
                        </div>
                        <div class="data-item">
                            <div>AUTO BRK</div>
                            <div id="res-autobrake">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="height: 50px;"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('roster')" id="btn-roster">
            <span class="nav-icon">üìÖ</span><span>ROSTER</span>
        </button>
        <button class="nav-btn" onclick="switchTab('calc')" id="btn-calc">
            <span class="nav-icon">üßÆ</span><span>DISPATCH</span>
        </button>
    </div>

<script>
    // --- Âü∫Á§éË®≠ÂÆö ---
    const PAX_UNIT_WEIGHT = 44; // ÂñÆ‰∏Ä‰πòÂÆ¢ÈáçÈáè (KG)

    // --- ÂÆâÂÖ®Â≠òÂèñ LocalStorage (Èò≤Ê≠¢ Safari Â†±ÈåØ) ---
    function safeGet(key) { try { return localStorage.getItem(key); } catch(e) { return null; } }
    function safeSet(key, val) { try { localStorage.setItem(key, val); } catch(e) {} }
    function safeRem(key) { try { localStorage.removeItem(key); } catch(e) {} }

    // --- ÂàùÂßãÂåñÁãÄÊÖã ---
    let completedFlights = JSON.parse(safeGet('tk_roster_v14')) || {};

    // --- Á∂≤È†ÅËºâÂÖ•Âü∑Ë°å ---
    window.onload = function() {
        // Ê™¢Êü•Ë≥áÊñôÂ∫´ÊòØÂê¶ÈÄ£Êé•ÊàêÂäü
        if (!window.flightDB || !window.perfDB) {
            alert("‚ö†Ô∏è ÈåØË™§ÔºöË≥áÊñôÂ∫´Êú™ËºâÂÖ•ÔºÅ\nË´ãÁ¢∫Ë™ç roster.js Ëàá perf_db.js Ê™îÊ°àÊòØÂê¶Â≠òÂú®„ÄÇ");
        } else {
            renderRoster(); // Ê∏≤ÊüìÁè≠Ë°®
        }
        loadInputs(); // ËºâÂÖ•‰∏äÊ¨°Êï∏Êìö
    };

    // --- ÂàÜÈ†ÅÂàáÊèõ ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        document.getElementById('btn-' + tabName).classList.add('active');
    }

    // --- Áè≠Ë°®Ê∏≤ÊüìÈÇèËºØ ---
    function renderRoster() {
        const list = document.getElementById('roster-list');
        list.innerHTML = '';
        if(!window.flightDB) return;

        for (const [flightNo, data] of Object.entries(window.flightDB)) {
            const isDone = completedFlights[flightNo] === true;
            const card = document.createElement('div');
            card.className = `flight-card ${isDone ? 'completed' : ''}`;
            card.onclick = (e) => {
                if(e.target.classList.contains('check-btn')) return;
                loadFlightToCalc(flightNo);
            };
            card.innerHTML = `
                <div class="flight-info">
                    <div class="flight-day">${data.day} | ${flightNo}</div>
                    <div class="flight-route">${data.r}</div>
                    <div class="flight-desc">${data.d}</div>
                </div>
                <button class="check-btn" onclick="toggleComplete('${flightNo}')">‚úì</button>
            `;
            list.appendChild(card);
        }
    }

    function toggleComplete(flightNo) {
        if (completedFlights[flightNo]) delete completedFlights[flightNo];
        else completedFlights[flightNo] = true;
        safeSet('tk_roster_v14', JSON.stringify(completedFlights));
        renderRoster();
    }

    function loadFlightToCalc(flightNo) {
        const data = window.flightDB[flightNo];
        if (!data) return;
        
        document.getElementById('pax-count').value = data.pax;
        document.getElementById('cargo-fwd').value = data.f;
        document.getElementById('cargo-aft').value = data.a;
        document.getElementById('calc-flight-title').innerText = `${flightNo}`;
        document.getElementById('calc-flight-desc').innerText = data.r + " | " + data.d;
        
        updatePaxWeight(); 
        updateTotalCargo(); 
        saveInputs(); 
        switchTab('calc');
    }

    // --- ËºîÂä©Ë®àÁÆó ---
    function updatePaxWeight() { 
        let count = parseFloat(document.getElementById("pax-count").value) || 0;
        document.getElementById("pax-weight").value = count * PAX_UNIT_WEIGHT;
    }
    function updateTotalCargo() { 
        let f = parseFloat(document.getElementById("cargo-fwd").value) || 0;
        let a = parseFloat(document.getElementById("cargo-aft").value) || 0;
        document.getElementById("cargo-total").value = f + a;
    }

    // --- Ê†∏ÂøÉÁÆóÊ≥ïÔºöÁ∑öÊÄßÊèíÂÄº (Linear Interpolation) ---
    function interpolate(weight, table) {
        // table Ê†ºÂºè: [[130, v1, vr, v2], [140, v1, vr, v2]...]
        for (let i = 0; i < table.length - 1; i++) {
            let lower = table[i];
            let upper = table[i+1];
            
            // ÊâæÂà∞ÈáçÈáèÊâÄÂú®ÁöÑÂçÄÈñì (‰æãÂ¶Ç 195T Âú® 190T Âíå 200T ‰πãÈñì)
            if (weight >= lower[0] && weight <= upper[0]) {
                let ratio = (weight - lower[0]) / (upper[0] - lower[0]); // Ë®àÁÆóÊØî‰æã (0.0 ~ 1.0)
                
                // ‰æùÊØî‰æãË®àÁÆó V1, VR, V2
                let v1 = lower[1] + ratio * (upper[1] - lower[1]);
                let vr = lower[2] + ratio * (upper[2] - lower[2]);
                let v2 = lower[3] + ratio * (upper[3] - lower[3]);
                
                return { v1: v1, vr: vr, v2: v2 };
            }
        }
        // Â¶ÇÊûúË∂ÖÈáçÊàñÈÅéËºïÔºåÁõ¥Êé•ÂõûÂÇ≥ÈÇäÁïåÂÄº
        if (weight < table[0][0]) return { v1:table[0][1], vr:table[0][2], v2:table[0][3] };
        let last = table[table.length-1];
        return { v1:last[1], vr:last[2], v2:last[3] };
    }

    function interpolateVLS(weight, table) {
        for (let i = 0; i < table.length - 1; i++) {
            let lower = table[i];
            let upper = table[i+1];
            if (weight >= lower[0] && weight <= upper[0]) {
                let ratio = (weight - lower[0]) / (upper[0] - lower[0]);
                return lower[1] + ratio * (upper[1] - lower[1]);
            }
        }
        return 160; // È†êË®≠ÂÄº
    }

    // --- ‰∏ªË®àÁÆóÂáΩÊï∏ (Calculate Performance) ---
    function calculate() {
        if(!window.perfDB) return alert("Perf DB missing");

        // 1. ÂèñÂæóÈáçÈáèÊï∏Êìö
        let oew = 129855; // Á©∫Èáç
        let paxWt = parseFloat(document.getElementById('pax-weight').value) || 0;
        let cargo = parseFloat(document.getElementById('cargo-total').value) || 0;
        let fuel = parseFloat(document.getElementById('fuel-total').value) || 0;
        let trip = parseFloat(document.getElementById('trip-fuel').value) || 0;

        let tow = (oew + paxWt + cargo + fuel) / 1000; // Ëµ∑È£õÈáç (Âô∏)
        let ldw = (tow * 1000 - trip) / 1000;          // ËêΩÂú∞Èáç (Âô∏)

        // 2. ÂèñÂæóÁí∞Â¢ÉÊï∏Êìö
        let rwyLen = parseFloat(document.getElementById('rwy-len').value) || 3000;
        let isWet = document.getElementById('rwy-cond').value === 'WET';
        let windDir = parseFloat(document.getElementById('wind-dir').value) || 0;
        let windSpd = parseFloat(document.getElementById('wind-spd').value) || 0;
        let rwyHdg = parseFloat(document.getElementById('rwy-hdg').value) || 0;

        // Ë®àÁÆóÈ†ÇÈ¢®ÂàÜÈáè (Headwind)
        // ÂÖ¨ÂºèÔºöÈ¢®ÈÄü * cos(È¢®ÂêëËàáË∑ëÈÅìÂ§æËßí)
        let angle = Math.abs(rwyHdg - windDir) * (Math.PI / 180);
        let headwind = Math.cos(angle) * windSpd;

        // 3. Ëµ∑È£õÈÅãÁÆó (Takeoff)
        // 3a. Êü•Ë°®ÂèñÂæóÂü∫Á§éÈÄüÂ∫¶ (1+F)
        let spd = interpolate(tow, window.perfDB.takeoff_speeds);
        
        // 3b. Ê±∫ÂÆöÊßãÂûã (Config)
        let conf = "1+F";
        if (rwyLen < 2400 || tow > 230) conf = "2"; // Áü≠Ë∑ëÈÅìÊàñÈáçËºâÊîπÁî® Conf 2
        
        // 3c. ÊáâÁî®ÊßãÂûã‰øÆÊ≠£
        let correction = window.perfDB.conf_correction[conf] || {v1:0, vr:0, v2:0};
        let v1 = spd.v1 + correction.v1;
        let vr = spd.vr + correction.vr;
        let v2 = spd.v2 + correction.v2;

        // 3d. V1 Ë∑ëÈÅì‰øÆÊ≠£ (Ë∑ëÈÅìË∂äÁü≠ÔºåV1 Ë¶ÅË∂äÂ∞è‰ª•‰øùÁïôÁÖûËªäË∑ùÈõ¢)
        if (rwyLen < 2200) v1 -= 4;
        if (isWet) v1 -= 2; // ÊøïÊªëË∑ëÈÅì V1 ÂÜçÊ∏õ

        // 3e. Flex Temp Ë®àÁÆó
        let flexData = window.perfDB.flex_data;
        let wReward = (flexData.mtow - tow) * flexData.slope_weight; // ÈáçÈáèÁçéÂãµ
        let rReward = Math.max(0, (rwyLen - 2500) * flexData.slope_runway); // Ë∑ëÈÅìÁçéÂãµ
        let windReward = Math.max(0, headwind * 0.5); // È†ÇÈ¢®ÁçéÂãµ
        
        let flex = Math.floor(flexData.base_temp + wReward + rReward + windReward);
        if (flex > flexData.max_temp) flex = flexData.max_temp;
        
        // ÂÆâÂÖ®ÈôêÂà∂ÔºöÊ•µÁü≠Ë∑ëÈÅìÊàñÊøïÊªëË∑ëÈÅìÂª∫Ë≠∞ TOGA
        if (rwyLen < 2000 || (isWet && rwyLen < 2400)) flex = "TOGA";

        // 3f. Trim Ë®àÁÆó (Á∞°ÂåñÁâà)
        let cg = 28.5; // ÂÅáË®≠Âπ≥ÂùáÈáçÂøÉ
        let trimVal = (window.perfDB.trim_data.ref_cg - cg) * window.perfDB.trim_data.step;
        let trimStr = (trimVal >= 0 ? "UP " : "DN ") + Math.abs(trimVal).toFixed(1);

        // 4. ÈôçËêΩÈÅãÁÆó (Landing)
        let vls = interpolateVLS(ldw, window.perfDB.landing_vls_full);
        let windCorr = Math.max(5, Math.min(15, headwind / 3)); // ÊúÄÂ∞è+5, ÊúÄÂ§ß+15
        let vapp = Math.round(vls + windCorr);

        let autobrake = "LO";
        if (rwyLen < 2400 || isWet) autobrake = "MED";

        // 5. Êõ¥Êñ∞‰ªãÈù¢È°ØÁ§∫
        document.getElementById('res-tow').innerText = tow.toFixed(1) + " T";
        document.getElementById('res-ldw').innerText = ldw.toFixed(1) + " T";
        
        document.getElementById('res-conf').innerText = conf;
        document.getElementById('res-flex').innerText = (flex === "TOGA") ? "TOGA" : flex + "¬∞";
        document.getElementById('res-trim').innerText = trimStr;
        
        document.getElementById('res-v1').innerText = Math.round(v1);
        document.getElementById('res-vr').innerText = Math.round(vr);
        document.getElementById('res-v2').innerText = Math.round(v2);

        document.getElementById('res-vapp').innerText = vapp;
        document.getElementById('res-autobrake').innerText = autobrake;

        saveInputs(); // Ëá™ÂãïÂ≠òÊ™î
    }

    // --- Â≠òÊ™îÁ≥ªÁµ± (Save/Load) ---
    function saveInputs() {
        const data = {
            pax: document.getElementById('pax-count').value,
            fwd: document.getElementById('cargo-fwd').value,
            aft: document.getElementById('cargo-aft').value,
            fuel: document.getElementById('fuel-total').value,
            trip: document.getElementById('trip-fuel').value,
            rwyLen: document.getElementById('rwy-len').value,
            rwyCond: document.getElementById('rwy-cond').value,
            windDir: document.getElementById('wind-dir').value,
            windSpd: document.getElementById('wind-spd').value,
            rwyHdg: document.getElementById('rwy-hdg').value,
            title: document.getElementById('calc-flight-title').innerText,
            desc: document.getElementById('calc-flight-desc').innerText
        };
        safeSet('tk_calc_inputs_v14', JSON.stringify(data));
    }

    function loadInputs() {
        const saved = safeGet('tk_calc_inputs_v14');
        if (saved) {
            try {
                const d = JSON.parse(saved);
                if(d.pax) document.getElementById('pax-count').value = d.pax;
                if(d.fwd) document.getElementById('cargo-fwd').value = d.fwd;
                if(d.aft) document.getElementById('cargo-aft').value = d.aft;
                if(d.fuel) document.getElementById('fuel-total').value = d.fuel;
                if(d.trip) document.getElementById('trip-fuel').value = d.trip;
                if(d.rwyLen) document.getElementById('rwy-len').value = d.rwyLen;
                if(d.rwyCond) document.getElementById('rwy-cond').value = d.rwyCond;
                if(d.windDir) document.getElementById('wind-dir').value = d.windDir;
                if(d.windSpd) document.getElementById('wind-spd').value = d.windSpd;
                if(d.rwyHdg) document.getElementById('rwy-hdg').value = d.rwyHdg;
                if(d.title) document.getElementById('calc-flight-title').innerText = d.title;
                if(d.desc) document.getElementById('calc-flight-desc').innerText = d.desc;
                updatePaxWeight(); updateTotalCargo();
            } catch(e) {}
        }
    }

    function clearAllData() {
        if(confirm("Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâË≥áÊñôÂóéÔºü\n(ÂåÖÂê´Áè≠Ë°®ÈÄ≤Â∫¶ÂíåÂ∑≤Ëº∏ÂÖ•ÁöÑÊï∏Êìö)")) {
            safeRem('tk_calc_inputs_v14');
            safeRem('tk_roster_v14');
            location.reload();
        }
    }
</script>
</body>
</html>

