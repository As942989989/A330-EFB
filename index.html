<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1e1e">
    <title>TK A330 EFB (Split)</title>
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAAbFBMVEUAAADjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgDjCgAAAADc0A/lAAAAI3RSTlMAGfCc7vO/gH+wPzC/r39gcGBfX14/MC8vL29vX19fX19fX19J15N5AAAEZUlEQVR42u3c6XbiOhSA4QyBQBodmjaF0vZ+3/+VFs4wQ7FkK7YkK3V9/5WzkCw/WfaSjXF9fX19fX19fX19fX19fX19fX19fX19fX19fX39/9T159v7+8fH+/v72/P19fXydv94//h4f76/f37V9X/W9e324/3j9e3t9fX5/Pj4eP/2/vz4fH97fX1/v/34Vdf/T9f3t/e3t+fH+/vH6+v7x8fb8/vbe13/T93e357fP5/v7+/P7+/Pj4/3t+f6/f/r29v7x/Pj4/3t+fH+/vH89l6v/5e6vb09Pz/eP96fnx/vH2/P9fr/Vbe3t/f3t/fn+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/vz+/v7/6/r/wO4gJ5C1X7n2AAAAABJRU5ErkJggg==">
    
    <style>
        /* CSS Ê®£ÂºèËàá‰πãÂâçÁõ∏Âêå */
        body { background-color: #0d0d0d; color: #ccc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; margin: 0; padding: 0; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); -webkit-user-select: none; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .nav-header { background-color: #1e1e1e; border-bottom: 2px solid #e30a17; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; color: #fff; z-index: 10; display: flex; justify-content: space-between; align-items: center; padding-top: max(15px, env(safe-area-inset-top)); margin-top: -env(safe-area-inset-top); }
        .reset-btn { background: #333; color: #888; border: 1px solid #555; font-size: 10px; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        .content-container { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 15px; padding-bottom: 100px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background-color: #1e1e1e; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(20px, env(safe-area-inset-bottom)); z-index: 20; }
        .nav-btn { background: none; border: none; color: #666; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .nav-btn.active { color: #e30a17; }
        .nav-icon { font-size: 20px; }
        .flight-card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 8px; margin-bottom: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; transition: 0.2s; }
        .flight-card:active { background-color: #2a2a2a; }
        .flight-info { flex: 1; margin-right: 10px; }
        .flight-day { font-size: 12px; color: #e30a17; font-weight: bold; margin-bottom: 4px; }
        .flight-route { font-size: 15px; color: #fff; font-weight: bold; margin-bottom: 6px; }
        .flight-desc { font-size: 13px; color: #bbb; line-height: 1.5; white-space: normal; word-break: break-word; }
        .flight-card.completed { opacity: 0.5; border-color: #2ecc71; }
        .flight-card.completed .flight-day { color: #2ecc71; }
        .check-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #555; background: none; display: flex; justify-content: center; align-items: center; color: transparent; flex-shrink: 0; margin-top: 5px; }
        .flight-card.completed .check-btn { background-color: #2ecc71; border-color: #2ecc71; color: #000; }
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        label { font-size: 12px; color: #eee; }
        input { width: 90px; background-color: #000; border: 1px solid #444; color: #00ff00; font-family: monospace; font-size: 16px; text-align: right; padding: 8px; border-radius: 4px; }
        .section-header { font-size: 12px; color: #e30a17; font-weight: bold; margin-top: 20px; margin-bottom: 8px; border-bottom: 1px dashed #444; padding-bottom: 2px; }
        .btn-calc { width: 100%; padding: 15px; background-color: #e30a17; color: #fff; border: none; font-size: 16px; font-weight: bold; margin-top: 20px; border-radius: 6px; }
        .result-box { background-color: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .res-table { width: 100%; border-collapse: collapse; }
        .res-table td { padding: 4px 0; vertical-align: middle; }
        .res-label { font-size: 12px; color: #888; width: 30%; }
        .res-cg { font-size: 12px; color: #fff; width: 25%; text-align: right; }
        .res-val { font-size: 15px; color: #00ff00; font-weight: bold; text-align: right; }
        .res-pct { font-size: 11px; color: #00bfff; text-align: right; padding-left: 5px;}
        .divider { border-bottom: 1px solid #222; margin: 8px 0; }
        .warning-text { color: #e74c3c !important; }
        #flight-input-area { display: none; }
        .current-flight-banner { background: #2a2a2a; padding: 10px; border-left: 4px solid #00bfff; margin-bottom: 15px; border-radius: 4px; }
        .banner-desc { font-size: 12px; color: #ddd; margin-top: 4px; line-height: 1.4; }
        #rescue-btn { display: none; width: 100%; padding: 10px; margin-top: 20px; background: #333; border: 1px dashed #666; color: #fff; }
    </style>
</head>
<body>

    <script src="roster.js"></script>

    <div class="nav-header">
        TK A330 EFB
        <button class="reset-btn" onclick="clearAllData()">RESET ALL</button>
    </div>

    <div class="content-container">
        <div id="tab-roster" class="tab-content active">
            <div id="roster-list"></div>
            <button id="rescue-btn" onclick="location.reload()">‚ö†Ô∏è Ë≥áÊñôÂ∫´Êú™ËºâÂÖ•ÔºüÈªûÊ≠§ÈáçÊï¥</button>
            <div style="text-align:center; color:#555; font-size:12px; margin-top:20px;">‚Äî END OF ROSTER ‚Äî</div>
        </div>

        <div id="tab-calc" class="tab-content">
            <div class="current-flight-banner">
                <div style="font-size:12px; color:#aaa;">CURRENT FLIGHT</div>
                <div id="calc-flight-title" style="color:#fff; font-weight:bold; font-size:16px;">NO FLIGHT SELECTED</div>
                <div id="calc-flight-desc" class="banner-desc">Please select from Roster</div>
            </div>
            <div class="section-header">LOAD DATA</div>
            <div class="input-row"><label>OEW</label><input type="number" id="oew" value="129855" oninput="saveInputs()"></div>
            <div class="input-row"><label>PAX</label><input type="number" id="pax-count" oninput="updatePaxWeight(); saveInputs();"></div>
            <div class="input-row"><label>PAX WT</label><input type="number" id="pax-weight" readonly style="color:#666; border-color:#333;"></div>
            
            <div class="section-header">CARGO SPLIT</div>
            <div class="input-row"><label>FWD</label><input type="number" id="cargo-fwd" oninput="updateTotalCargo(); saveInputs();"></div>
            <div class="input-row"><label>AFT</label><input type="number" id="cargo-aft" oninput="updateTotalCargo(); saveInputs();"></div>
            <div class="input-row"><label>TOTAL</label><input type="number" id="cargo-total" readonly style="color:#666; border-color:#333;"></div>

            <div class="section-header">FUEL & PERF</div>
            <div class="input-row"><label>T.FUEL</label><input type="number" id="fuel-total" oninput="saveInputs()"></div>
            <div class="input-row"><label style="color:#ff9900;">TRIP</label><input type="number" id="trip-fuel" style="border-color:#ff9900;" oninput="saveInputs()"></div>
            <div class="input-row"><label>OAT / FLEX</label><div style="display:flex; gap:5px;"><input type="number" id="oat" placeholder="OAT" oninput="saveInputs()"><input type="number" id="flex" placeholder="FLEX" oninput="saveInputs()"></div></div>

            <button class="btn-calc" onclick="calculate()">CALCULATE</button>

            <div class="result-box">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="color:#888; font-size:12px;">WEIGHT CHECK</span>
                    <span id="weight-check" style="font-size:12px; font-weight:bold; color:#fff;">--- / ---</span>
                </div>
                <table class="res-table">
                    <tr><td class="res-label">T.O. TRIM</td><td class="res-cg" id="res-tocg">CG --%</td><td class="res-val" id="res-totrim">--</td><td class="res-pct" id="res-to-pct">(--%)</td></tr>
                    <tr><td class="res-label" style="color:#00bfff;">CRZ TRIM</td><td class="res-cg" id="res-crzcg" style="color:#aaa;">CG --%</td><td class="res-val" id="res-crztrim" style="color:#00bfff;">--</td><td class="res-pct" id="res-crz-pct">(--%)</td></tr>
                    <tr><td class="res-label" style="color:#ffcc00;">LDG TRIM</td><td class="res-cg" id="res-ldgcg" style="color:#aaa;">CG --%</td><td class="res-val" id="res-ldgtrim" style="color:#ffcc00;">--</td><td class="res-pct" id="res-ldg-pct">(--%)</td></tr>
                </table>
                <div class="divider"></div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="res-label">N1 TARGET</span><span id="res-n1" style="font-size:18px; font-weight:bold; color:#fff;">--.-%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('roster')" id="btn-roster"><span class="nav-icon">üìÖ</span><span>ROSTER</span></button>
        <button class="nav-btn" onclick="switchTab('calc')" id="btn-calc"><span class="nav-icon">üßÆ</span><span>DISPATCH</span></button>
    </div>

<script>
    const PAX_UNIT_WEIGHT = 84;
    // --- Ê†∏ÂøÉÂÆâÂÖ®ÈÇèËºØ ---
    function safeGetItem(key) { try { return localStorage.getItem(key); } catch(e) { return null; } }
    function safeSetItem(key, val) { try { localStorage.setItem(key, val); } catch(e) {} }
    function safeRemoveItem(key) { try { localStorage.removeItem(key); } catch(e) {} }

    let completedFlights = JSON.parse(safeGetItem('tk_roster_split_v13')) || {};

    window.onload = function() {
        // Ê™¢Êü• roster.js ÊòØÂê¶ËºâÂÖ•ÊàêÂäü
        if (typeof window.flightDB === 'undefined') {
            document.getElementById('rescue-btn').style.display = 'block';
            alert("‚ö†Ô∏è ÈåØË™§ÔºöÊâæ‰∏çÂà∞Áè≠Ë°®Ë≥áÊñôÂ∫´„ÄÇ\nË´ãÁ¢∫Ë™ç roster.js Ê™îÊ°àÂ≠òÂú®‰∏îÂú®Âêå‰∏ÄÁõÆÈåÑ‰∏ã„ÄÇ");
        } else {
            renderRoster();
        }
        loadInputs();
    };

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        document.getElementById('btn-' + tabName).classList.add('active');
    }

    function renderRoster() {
        const list = document.getElementById('roster-list');
        list.innerHTML = '';
        if(!window.flightDB) return; // double check

        for (const [flightNo, data] of Object.entries(window.flightDB)) {
            const isDone = completedFlights[flightNo] === true;
            const card = document.createElement('div');
            card.className = `flight-card ${isDone ? 'completed' : ''}`;
            card.onclick = (e) => {
                if(e.target.classList.contains('check-btn')) return;
                loadFlightToCalc(flightNo);
            };
            card.innerHTML = `
                <div class="flight-info">
                    <div class="flight-day">${data.day} | ${flightNo}</div>
                    <div class="flight-route">${data.r}</div>
                    <div class="flight-desc">${data.d}</div>
                </div>
                <button class="check-btn" onclick="toggleComplete('${flightNo}')">‚úì</button>
            `;
            list.appendChild(card);
        }
    }

    function toggleComplete(flightNo) {
        if (completedFlights[flightNo]) delete completedFlights[flightNo];
        else completedFlights[flightNo] = true;
        safeSetItem('tk_roster_split_v13', JSON.stringify(completedFlights));
        renderRoster();
    }

    function loadFlightToCalc(flightNo) {
        const data = window.flightDB[flightNo];
        if (!data) return;
        document.getElementById('pax-count').value = data.pax;
        document.getElementById('cargo-fwd').value = data.f;
        document.getElementById('cargo-aft').value = data.a;
        document.getElementById('calc-flight-title').innerText = `${flightNo} (CI ${data.ci})`;
        document.getElementById('calc-flight-desc').innerText = `${data.r} | ${data.d}`;
        updatePaxWeight(); updateTotalCargo(); saveInputs(); switchTab('calc');
    }

    function updatePaxWeight() { document.getElementById("pax-weight").value = (parseFloat(document.getElementById("pax-count").value) || 0) * PAX_UNIT_WEIGHT; }
    function updateTotalCargo() { document.getElementById("cargo-total").value = (parseFloat(document.getElementById("cargo-fwd").value) || 0) + (parseFloat(document.getElementById("cargo-aft").value) || 0); }

    function calculate() {
        let oew = parseFloat(document.getElementById('oew').value), paxWt = parseFloat(document.getElementById('pax-weight').value) || 0,
            cFwd = parseFloat(document.getElementById("cargo-fwd").value) || 0, cAft = parseFloat(document.getElementById("cargo-aft").value) || 0,
            fuel = parseFloat(document.getElementById('fuel-total').value) || 0, tripFuel = parseFloat(document.getElementById('trip-fuel').value) || 0,
            oat = parseFloat(document.getElementById('oat').value), flex = parseFloat(document.getElementById('flex').value);
        
        let tow = oew + paxWt + cFwd + cAft + fuel, ldw = tow - tripFuel, midW = tow - (tripFuel/2);
        document.getElementById('weight-check').innerHTML = `${(tow/1000).toFixed(1)}T / ${(ldw/1000).toFixed(1)}T`;

        let armOEW = 22.0, armPax = 32.0, armFwd = -60.0, armAft = 80.0, armFuel = 28.0;
        let totalMomentTO = (oew*armOEW) + (paxWt*armPax) + (cFwd*armFwd) + (cAft*armAft) + (fuel*armFuel);
        
        let cgTO = totalMomentTO / tow;
        let cgCrz = (totalMomentTO - ((tripFuel/2)*armFuel)) / midW;
        let cgLdg = (totalMomentTO - (tripFuel*armFuel)) / ldw;

        function calcTrim(cg) { let v = (30-cg)*0.17; return v>13.5?13.5:(v<-4?-4:v); }
        function fmtTrim(v) { return (v>=0?"UP ":"DN ") + Math.abs(v).toFixed(1); }
        function fmtPct(v) { let p = v>=0 ? (v/13.5)*100 : (v/-4)*-100; return (p>0?"+":"") + p.toFixed(0) + "%"; }

        let tTO = calcTrim(cgTO), tCrz = calcTrim(cgCrz), tLdg = calcTrim(cgLdg);
        
        document.getElementById('res-n1').innerText = !isNaN(oat) ? (98.2-(Math.max(0,(flex||oat)-30)*0.26)).toFixed(1)+"%" : "--.-%";
        document.getElementById('res-tocg').innerText = cgTO.toFixed(1)+"%"; document.getElementById('res-totrim').innerText = fmtTrim(tTO); document.getElementById('res-to-pct').innerText = "("+fmtPct(tTO)+")";
        document.getElementById('res-crzcg').innerText = cgCrz.toFixed(1)+"%"; document.getElementById('res-crztrim').innerText = fmtTrim(tCrz); document.getElementById('res-crz-pct').innerText = "("+fmtPct(tCrz)+")";
        document.getElementById('res-ldgcg').innerText = cgLdg.toFixed(1)+"%"; document.getElementById('res-ldgtrim').innerText = fmtTrim(tLdg); document.getElementById('res-ldg-pct').innerText = "("+fmtPct(tLdg)+")";
        saveInputs();
    }

    function saveInputs() {
        const data = { oew: document.getElementById('oew').value, pax: document.getElementById('pax-count').value, fwd: document.getElementById('cargo-fwd').value, aft: document.getElementById('cargo-aft').value, fuel: document.getElementById('fuel-total').value, trip: document.getElementById('trip-fuel').value, oat: document.getElementById('oat').value, flex: document.getElementById('flex').value, title: document.getElementById('calc-flight-title').innerText, desc: document.getElementById('calc-flight-desc').innerText };
        safeSetItem('tk_calc_inputs_split_v13', JSON.stringify(data));
    }
    function loadInputs() {
        const d = JSON.parse(safeGetItem('tk_calc_inputs_split_v13'));
        if(d) { 
            if(d.oew) document.getElementById('oew').value = d.oew; if(d.pax) document.getElementById('pax-count').value = d.pax;
            if(d.fwd) document.getElementById('cargo-fwd').value = d.fwd; if(d.aft) document.getElementById('cargo-aft').value = d.aft;
            if(d.fuel) document.getElementById('fuel-total').value = d.fuel; if(d.trip) document.getElementById('trip-fuel').value = d.trip;
            if(d.oat) document.getElementById('oat').value = d.oat; if(d.flex) document.getElementById('flex').value = d.flex;
            if(d.title) document.getElementById('calc-flight-title').innerText = d.title; if(d.desc) document.getElementById('calc-flight-desc').innerText = d.desc;
            updatePaxWeight(); updateTotalCargo();
        }
    }
    function clearAllData() { if(confirm("RESET?")) { safeRemoveItem('tk_calc_inputs_split_v13'); safeRemoveItem('tk_roster_split_v13'); location.reload(); } }
</script>
</body>
</html>
